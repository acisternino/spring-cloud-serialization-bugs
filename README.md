# Spring Cloud Stream test project

This is a sample project to reproduce two issues I have found in v4.1.3 of
[Spring Cloud Stream](https://github.com/spring-cloud/spring-cloud-stream):

- https://github.com/spring-cloud/spring-cloud-stream/issues/2979
- https://github.com/spring-cloud/spring-cloud-stream/issues/2980

Both issues are related to the serialization to JSON of date or time
related properties.

## Setup

I couldn't manage to move the demo code to a unit test. Therefore, some
preparation work is needed to be able to reproduce and observe the
problems.

Prerequisites:

- A working Docker (or Podman) environment.
- JDK 21 installed.

Preparation:

1. In a terminal window, bring up an instance of RabbitMQ using the
   provided `docker-compose.yml` file.

   ```shell
   $ docker compose up
   ```

2. In the browser, connect to the admin page of the running instance at
   `http://localhost:15672` with credentials `guest`/`guest`
3. Create a **topic** exchange named `springcloud.test` with default
   properties.
4. Create a classic queue named `output.test` (or whatever you like)
5. Bind it to the exchange with the `#` routing key.

These steps should set up a RabbitMQ working instance and the means to
observe the output generated by the Java project.

To check the messages open the output queue page and use the **"Get
messages"** feature to fetch messages from the queue.

After setting up RabbitMQ, open a second terminal window and clone this
repository:

```shell
$ git clone https://github.com/acisternino/spring-cloud-serialization-bugs
$ cd spring-cloud-serialization-bugs
```
---

## Test Issue #2979

Link: https://github.com/spring-cloud/spring-cloud-stream/issues/2979

### With Spring Cloud Stream 4.1.3

Run the Spring Boot application without modifications:

```shell
$ ./gradlew clean bootRun
```

This will use Spring Cloud Dependencies v2023.0.3 that includes Spring
Cloud Stream v4.1.3.

In a terminal window send a simple HTTP POST requests that triggers the
correct endpoint:

```shell
$ curl -XPOST 'localhost:8080/string-vs-timestamp'
```

The following message will be found in the queue:

```json
{
  "type": "StringVsTimestamp",
  "date": 1722597051523,
  "zonedDateTime": 1722597051.523563000
}
```

Note the numeric format for the two timestamps and the difference between
the two: one is in millisecond and the other is in seconds with decimals.

### With Spring Cloud Stream 4.1.2

Change the `build.gradle.kts` file and use Spring Cloud Dependencies
v2023.0.2.

Stop and run the Spring Boot application again:

```shell
$ ./gradlew clean bootRun
```

Trigger the same endpoint as before:

```shell
$ curl -XPOST 'localhost:8080/string-vs-timestamp'
```

The following message will be found in the queue:

```json
{
  "type": "StringVsTimestamp",
  "date": "2024-08-02T11:17:21.317+00:00",
  "zonedDateTime": "2024-08-02T13:17:21.317129+02:00"
}
```

Note that timestamps are now converted to a String representation that is
again slightly different between the two objects.

---

## Test Issue #2980

Link: https://github.com/spring-cloud/spring-cloud-stream/issues/2980

Restore the Spring Cloud Dependencies version to v2023.0.3 and run the
application again.

```shell
$ ./gradlew clean bootRun
```

Now trigger the dedicated endpoint:

```shell
$ curl -XPOST 'localhost:8080/instant-throws'
```

and observe the application's output.

We can see that sending [a bean](./src/main/java/com/example/demo_cloud/domain/AnnotatedInstantThrows.java)
containing a property of type `java.time.Instant` annotated with Jackson's
`@JsonFormat` throws the following exception during the process:

```
java.lang.NullPointerException: Cannot invoke "Object.getClass()" because "result" is null
    at org.springframework.cloud.function.cloudevent.CloudEventsFunctionInvocationHelper.doPostProcessResult(CloudEventsFunctionInvocationHelper.java:138) ~[spring-cloud-function-context-4.1.3.jar:4.1.3]
    at org.springframework.cloud.function.cloudevent.CloudEventsFunctionInvocationHelper.postProcessResult(CloudEventsFunctionInvocationHelper.java:114) ~[spring-cloud-function-context-4.1.3.jar:4.1.3]
    at org.springframework.cloud.function.cloudevent.CloudEventsFunctionInvocationHelper.postProcessResult(CloudEventsFunctionInvocationHelper.java:48) ~[spring-cloud-function-context-4.1.3.jar:4.1.3]
    at org.springframework.cloud.stream.function.StreamBridge.send(StreamBridge.java:214) ~[spring-cloud-stream-4.1.3.jar:4.1.3]
    at org.springframework.cloud.stream.function.StreamBridge.send(StreamBridge.java:168) ~[spring-cloud-stream-4.1.3.jar:4.1.3]
    at org.springframework.cloud.stream.function.StreamBridge.send(StreamBridge.java:163) ~[spring-cloud-stream-4.1.3.jar:4.1.3]
    at com.example.demo_cloud.DemoController.sendDomainObjectInstant(DemoController.java:54) ~[main/:na]
    ...
```

No message is sent in this case.

Now try commenting out the annotation:

```java
// @JsonFormat(shape = Shape.STRING, pattern = "yyyy-MM-dd'T'HH:mm:ss.SSSZ")
private Instant timestamp;
```

and try again. The object is sent without errors and the `Instant` property
is serialized according to the Spring Cloud Stream version used.

E.g. for v4.1.3 it is:

```json
{
  "type": "AnnotatedInstantThrows",
  "instant": 1722599194.823071000,
  "zonedDateTime": "2024-08-02T13:46:34.823+0200"
}
```

Note that other classes in the `java.time` package are not affected by the
same problem.
